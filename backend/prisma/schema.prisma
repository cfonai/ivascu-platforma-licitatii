generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String               @id @default(uuid())
  username             String               @unique
  password             String
  email                String               @unique
  role                 String
  createdAt            DateTime             @default(now())
  createdBy            String?
  adminNegotiations    Negotiation[]        @relation("AdminNegotiations")
  supplierNegotiations Negotiation[]        @relation("SupplierNegotiations")
  sentMessages         NegotiationMessage[]
  submittedOffers      Offer[]              @relation("SupplierOffers")
  clientOrders         Order[]              @relation("ClientOrders")
  supplierOrders       Order[]              @relation("SupplierOrders")
  createdRFQs          RFQ[]                @relation("ClientRFQs")
}

model RFQ {
  id           String        @id @default(uuid())
  clientId     String
  title        String
  description  String
  requirements String
  deadline     DateTime
  budget       Float?
  status       String        @default("draft")
  createdAt    DateTime      @default(now())
  publishedAt  DateTime?
  closedAt     DateTime?
  negotiations Negotiation[]
  offers       Offer[]
  orders       Order[]
  client       User          @relation("ClientRFQs", fields: [clientId], references: [id])
}

model Offer {
  id           String        @id @default(uuid())
  rfqId        String
  supplierId   String
  price        Float
  deliveryTime String
  description  String
  terms        String
  status       String        @default("submitted")
  isLocked     Boolean       @default(false)
  submittedAt  DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  negotiations Negotiation[]
  rfq          RFQ           @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  supplier     User          @relation("SupplierOffers", fields: [supplierId], references: [id])
  orders       Order[]
}

model Negotiation {
  id          String               @id @default(uuid())
  offerId     String
  rfqId       String
  adminId     String
  supplierId  String
  rounds      Int                  @default(0)
  status      String               @default("active")
  createdAt   DateTime             @default(now())
  completedAt DateTime?
  admin       User                 @relation("AdminNegotiations", fields: [adminId], references: [id])
  offer       Offer                @relation(fields: [offerId], references: [id], onDelete: Cascade)
  rfq         RFQ                  @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  supplier    User                 @relation("SupplierNegotiations", fields: [supplierId], references: [id])
  messages    NegotiationMessage[]
}

model NegotiationMessage {
  id                   String      @id @default(uuid())
  negotiationId        String
  senderId             String
  senderRole           String
  roundNumber          Int
  message              String
  proposedPrice        Float?
  proposedDeliveryTime String?
  createdAt            DateTime    @default(now())
  negotiation          Negotiation @relation(fields: [negotiationId], references: [id], onDelete: Cascade)
  sender               User        @relation(fields: [senderId], references: [id])
}

model Order {
  id                String    @id @default(uuid())
  rfqId             String
  offerId           String
  clientId          String
  supplierId        String
  finalPrice        Float
  finalTerms        String
  status            String    @default("created")
  isLocked          Boolean   @default(true)
  paymentMockStatus String    @default("pending")
  deliveryStatus    String    @default("pending")
  createdAt         DateTime  @default(now())
  finalizedAt       DateTime?
  archivedAt        DateTime?
  client            User      @relation("ClientOrders", fields: [clientId], references: [id])
  offer             Offer     @relation(fields: [offerId], references: [id])
  rfq               RFQ       @relation(fields: [rfqId], references: [id])
  supplier          User      @relation("SupplierOrders", fields: [supplierId], references: [id])
}
