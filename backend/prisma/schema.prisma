// Prisma Schema for Offer Intermediation Platform POC

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - supports 3 roles: admin, client, supplier
model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String   // hashed with bcrypt
  email     String   @unique
  role      String   // 'admin' | 'client' | 'supplier'
  createdAt DateTime @default(now())
  createdBy String?  // adminId who created this user (for client/supplier)

  // Relations
  createdRFQs          RFQ[]          @relation("ClientRFQs")
  submittedOffers      Offer[]        @relation("SupplierOffers")
  adminNegotiations    Negotiation[]  @relation("AdminNegotiations")
  supplierNegotiations Negotiation[]  @relation("SupplierNegotiations")
  sentMessages         NegotiationMessage[]
  clientOrders         Order[]        @relation("ClientOrders")
  supplierOrders       Order[]        @relation("SupplierOrders")
}

// RFQ (Request for Quotation) model
model RFQ {
  id          String      @id @default(uuid())
  clientId    String
  title       String
  description String
  requirements String
  deadline    DateTime
  budget      Float?      // optional
  status      String      @default("draft") // 'draft' | 'published' | 'offers_received' | 'negotiation' | 'final_offer_selected' | 'sent_to_client' | 'closed'
  createdAt   DateTime    @default(now())
  publishedAt DateTime?
  closedAt    DateTime?

  // Relations
  client       User          @relation("ClientRFQs", fields: [clientId], references: [id])
  offers       Offer[]
  negotiations Negotiation[]
  orders       Order[]
}

// Offer model
model Offer {
  id           String      @id @default(uuid())
  rfqId        String
  supplierId   String
  price        Float
  deliveryTime String
  description  String
  terms        String
  status       String      @default("submitted") // 'submitted' | 'under_review' | 'in_negotiation' | 'final_confirmed' | 'accepted' | 'rejected' | 'withdrawn'
  isLocked     Boolean     @default(false)
  submittedAt  DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relations
  rfq          RFQ           @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  supplier     User          @relation("SupplierOffers", fields: [supplierId], references: [id])
  negotiations Negotiation[]
  orders       Order[]
}

// Negotiation model
model Negotiation {
  id          String            @id @default(uuid())
  offerId     String
  rfqId       String
  adminId     String
  supplierId  String
  rounds      Int               @default(0) // max 3
  status      String            @default("active") // 'active' | 'completed' | 'cancelled'
  createdAt   DateTime          @default(now())
  completedAt DateTime?

  // Relations
  offer    Offer                @relation(fields: [offerId], references: [id], onDelete: Cascade)
  rfq      RFQ                  @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  admin    User                 @relation("AdminNegotiations", fields: [adminId], references: [id])
  supplier User                 @relation("SupplierNegotiations", fields: [supplierId], references: [id])
  messages NegotiationMessage[]
}

// Negotiation messages (conversation between Admin and Supplier)
model NegotiationMessage {
  id                  String   @id @default(uuid())
  negotiationId       String
  senderId            String
  senderRole          String   // 'admin' | 'supplier'
  roundNumber         Int      // 1-3
  message             String
  proposedPrice       Float?
  proposedDeliveryTime String?
  createdAt           DateTime @default(now())

  // Relations
  negotiation Negotiation @relation(fields: [negotiationId], references: [id], onDelete: Cascade)
  sender      User        @relation(fields: [senderId], references: [id])
}

// Order model
model Order {
  id               String             @id @default(uuid())
  rfqId            String
  offerId          String
  clientId         String
  supplierId       String
  finalPrice       Float
  finalTerms       String
  status           String             @default("created") // 'created' | 'payment_initiated' | 'payment_confirmed' | 'delivery_in_progress' | 'delivered' | 'received' | 'finalized' | 'archived'
  isLocked         Boolean            @default(true) // locked by default when created
  paymentMockStatus String            @default("pending") // 'pending' | 'initiated' | 'confirmed'
  deliveryStatus   String             @default("pending") // 'pending' | 'in_progress' | 'delivered' | 'received'
  createdAt        DateTime           @default(now())
  finalizedAt      DateTime?
  archivedAt       DateTime?

  // Relations
  rfq      RFQ    @relation(fields: [rfqId], references: [id])
  offer    Offer  @relation(fields: [offerId], references: [id])
  client   User   @relation("ClientOrders", fields: [clientId], references: [id])
  supplier User   @relation("SupplierOrders", fields: [supplierId], references: [id])
}
